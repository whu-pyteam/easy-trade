<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap 101 Template</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/login-register.css" rel="stylesheet">
    <style type="text/css">
        .navbar-nav > li > a {
            padding-top: 4px;
            padding-bottom: 0;
            height: 30px;
        }

        .navbar-right > li > a,
        .dropdown-menu > li > a {
            font-size: 12px;
        }

        .navbar {
            min-height: 20px;
        }

        .jumbotron {
            padding-top: 20px;
        }


        img{
            width: 300px;
            height: 300px;
        }
    </style>
</head>

<body>

<div th:replace="header::header(${type})"></div>



<div class="zt">
    <div class="container">
        <div class="row" id="goodInfo" style="border: 1px solid #E8E8E8; padding-top: 15px; padding-bottom: 15px;">
            <div class="col-lg-5">
                <img th:src="${ac01.aac106}"
                     style="height: 300px; width: 300px; overflow: hidden;" alt="啊咧，图片消失了"/>
            </div>
            <div class="col-lg-7">
                <div class="caption">
                    <h3 th:text="${ac01.aac102}"></h3>
                    <a th:href="@{sellerInfo.html(id=${ac01.aab101})}"><p th:text="${aab103}"></p></a>
                    <p th:text="'商品价格： '+${ac01.aac105}"></p>
                    <p th:text="'商品分类： '+${aac202}"></p>
                    <p th:text="'商品详情： '+${ac01.aac103}"></p>

                    <div id="otherPerson" style="display: none">
                        <a href="#" class="btn btn-primary" role="button" th:onclick="|javascript:addToCart('${ac01.aac101}')|">加入购物车</a>
                    </div>


                    <div id="buyer" style="display: none">
                        <a href="#" id="receiveGood" class="btn btn-success" role="button" th:onclick="|javascript:receiveGood('${ac01.aac101}')|">确认收货</a>
                    </div>

                    <div id="sellman" style="display: none">
                        <a href="#" id="sentGood" class="btn btn-primary" role="button" style="display: none" th:onclick="|javascript:sendGood('${ac01.aac101}')|">确认发货</a>
                        <a href="#" id="deleteGood" class="btn btn-danger" role="button" style="display: none" th:onclick="|javascript:deleteGood('${ac01.aac101}')|">删除商品</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="comment" style="display:none;">

            <p id="commentBuyer"></p>
            <p id="commentSeller"></p>
            <form id="commentForm" onsubmit="return false" action="#" method="post" style="display: none;">
                <div>
                    <label>评论：</label>
                    <input name="aad303" class="form-control" type="text">
                </div>
                <div>
                    <label>给几颗星：</label>
                    <input name="aad304" type="radio" value="5" checked>5
                    <input name="aad304" type="radio" value="4">4
                    <input name="aad304" type="radio" value="3">3
                    <input name="aad304" type="radio" value="2">2
                    <input name="aad304" type="radio" value="1">1
                </div>
                <div>
                    <input type="submit" class="btn btn-success" onclick="submitComment()">
                </div>
            </form>
        </div>
    </div>
</div>

<p id="assist" th:value="${ac01.aac101}" style="display: none">

<script src="js/jquery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/login-register.js"></script>
<script>
    var orderState;
    var username;
    var sellerId;
    var buyerId;
    var buyerhasComment;
    var sellerhasComment;
    var buyerComment;
    var sellerComment;
    var buyerStar;
    var sellerStar;

    function getCookie(cname)
    {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++)
        {
            var c = ca[i].trim();
            if (c.indexOf(name)==0) return c.substring(name.length,c.length);
        }
        return "";
    }

    function submitComment() {
        $.ajax({
            url:"submitComment.html",
            type: "post",
            data:{
                "aad303":$('input[name="aad303"]').val(),
                "aad304":$('input[name="aad304"]:checked').val(),
                "aab101":username,
                "aac101":$("#assist").attr("value")
            },
            success:function (data) {
                if(username==buyerId)
                {
                    $("#buyerHasComment").attr("value","1");
                }
                if(username==sellerId)
                {
                    $("#sellerHasComment").attr("value","1");
                }

                window.location.reload();
            }
        })
    }

    function deleteGood(productId) {
        $.post(
            "deleteGood.html",
            {id: productId},
            function (data) {
                if (data == true) {
                    window.location.replace("index.html");
                }
                if (data == false) {
                    alert("删除失败")
                    window.location.replace("index.html");
                }
            }
        );
    }

    function sendGood(productId)
    {
        if(orderState=="1")
        {
            alert("已发货")
        }
        if(orderState=="2")
        {
            alert("买家已收货")
        }
        if(orderState=="0")
        {
            $.post(
                "sendGood.html",
                {id: productId},
                function (data) {
                    if (data == true) {
                        alert("成功发货")

                        orderState="1";
                        window.location.reload();
                    }
                    if (data == false) {
                        alert("操作失败")
                        window.location.reload();
                    }
                }
            );
        }
    }

    function receiveGood(productId)
    {
        if(orderState=="0")
        {
            alert("卖家未发货")
        }
        if(orderState=="2")
        {
            alert("已收货")
        }
        if(orderState=="1")
        {
            $.post(
                "receiveGood.html",
                {id: productId},
                function (data) {
                    if (data == true) {
                        alert("成功收货");

                        orderState = "2";
                        window.location.reload();
                    }
                    if (data == false) {
                        alert("操作失败")
                        window.location.reload();
                    }
                }
            );
        }
    }


    function addToCart(productId) {
        $.post(
            "addToCart.html",
            {id: productId},
            function (data) {
                if (data == 0) {
                    window.location.replace("cart.html");
                }
                if (data == 1) {
                    alert("成功加入购物车");
                }
                if (data == 2) {
                    alert("没有未用户创建购物车");
                }
                if (data == 3) {
                    alert("购物车已经存在该商品");
                }
            }
        );
    }

    window.onload=function () {

        username = getCookie("userId");
        var productId = $("#assist").attr("value");
        if(username=="")
        {
            username="-1";
        }
        console.log(username+" "+productId);
        $.ajax({
            url: "sellerAndBuyer.html",
            type: "post",
            data: {"productId":productId},
            async: false,
            success: function (data) {
                console.log(data);
                var ids = data.split("&");
                sellerId=ids[0];
                buyerId=ids[1];
                orderState=ids[2];
                buyerhasComment=ids[3];
                sellerhasComment=ids[4];
                buyerComment=ids[5];
                sellerComment=ids[6];
                buyerStar=ids[7];
                sellerStar=ids[8];

                if(username == sellerId)
                {
                    $("#sellman").css("display","block");

                    if(orderState == "")
                    {
                        $("#deleteGood").css("display","inline-block");
                    }
                    else{
                        $("#sentGood").css("display","inline-block");
                        if(orderState == "2")
                        {
                            $("#comment").css("display","block");
                            if(sellerhasComment == "0") {
                                $("#commentForm").css("display", "block");
                            }
                            if(sellerhasComment == "1") {
                                $("#commentForm").css("display", "none");
                            }
                        }
                    }
                }
                else
                {
                    if(username == buyerId)
                    {
                        $("#buyer").css("display","block");
                        if(orderState == "2")
                        {
                            $("#comment").css("display","block");
                            console.log("here111")
                            if(buyerhasComment == "0") {
                                $("#commentForm").css("display", "block");
                            }
                            if(buyerhasComment == "1") {
                                console.log("here222")
                                $("#commentForm").css("display", "none");
                            }
                        }
                    }
                    else
                    {
                        if(buyerId=="") {
                            $("#otherPerson").css("display", "block");
                        }
                        if(orderState == "2")
                        {
                            $("#comment").css("display","block");
                        }
                    }
                }
            }
        })
        if(buyerhasComment==1)
        {
            $("#commentBuyer").append("买家说："+buyerComment+" 给出了"+buyerStar+"星评价");
        }
        if(sellerhasComment==1)
        {
            $("#commentSeller").append("卖家说："+sellerComment+" 给出了"+sellerStar+"星评价");
        }

    }

</script>

</body>

</html>